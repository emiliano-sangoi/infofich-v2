{% set page_id = 1 %}

{% extends "PlanificacionesBundle::planif-base.html.twig" %}


{% block tab_content %}
    {% include "PlanificacionesBundle:1-info-basica:form.html.twig" %}  
{% endblock %}


{% block javascripts %}
    {{ parent() }}
    <script>

        $(document).ready(function () {

            // combo de carreras:
            var select_carreras = $('#planificacionesbundle_planificacion_carrera');
            select_carreras.change(actualizarAsignaturas);
            
            //combo de asignaturas:
            //var select = $('#planificacionesbundle_planificacion_carrera');
            var select_asignatura = $('#planificacionesbundle_planificacion_asignatura');         
            select_asignatura.change(function (e) {
                var option = $(this).children("option:selected");
                var asignatura = JSON.parse(option.attr('data-json'));
                //var data_json = option.attr('data-json');
                
                console.log(option.attr('data-json'));
               // var option = select_carreras.children("option:selected");
               // var asignatura = JSON.parse(option.attr('data-json'));
               // $('#planificacionesbundle_planificacion_codigoSiu').val(asignatura.codigoMateria);
               // console.log(asignatura);
            });
            
        
{#            {% if is_planificacion_definida == false %}                #}
                //dispara el evento para que se actualicen el listado de asignaturas
                select_carreras.trigger('change');                
{#            {% endif %}#}
           
            
            select_asignatura.trigger('change');

        });


        /**
         * Actualiza el listado de asignaturas al cambiar la carrera elegida.
         *
         * @param {type} select
         * @returns {undefined}
         */
        function actualizarAsignaturas(event) {
            
            var select_carreras = $('#planificacionesbundle_planificacion_carrera');
             var select_asignatura = $('#planificacionesbundle_planificacion_asignatura');     
            // desactivar combo de asignaturas:
            select_asignatura.prop("disabled", true);

            var carrera = $(select_carreras).val();
            //console.log('Carrera elegida: ' + carrera);
            //Actualizar input Plan de estudio:
            var planes = JSON.parse($(select_carreras).attr('data-planes-carrera'));
            if (typeof planes === 'object' && typeof planes[carrera] === 'string') {
                $('#planificacionesbundle_planificacion_plan').attr('value', planes[carrera]);
            }

            //Define el ecomportamiento del select de asignatura sin disparar el evento:            
            // select_asignatura.addClass('disabled');
            {#select_asignatura.change(function (e) {
               // var option = $(this).children("option:selected");
                var option = select_carreras.children("option:selected");
                var asignatura = JSON.parse(option.attr('data-json'));
                $('#planificacionesbundle_planificacion_codigoSiu').val(asignatura.codigoMateria);
               // console.log(asignatura);
            });#}
            //setear la carrera en la url:
            var url = SECCIONES.get_asignaturas;
            url = url.replace('--CARRERA--', carrera);
            //llamada ajax
            $.ajax({
                dataType: "json",
                url: url,
                data: null,
                success: function (response) {

                    if (response.length > 0) {
                        var aux = select_asignatura.val();
                        select_asignatura.html('');
                        response.forEach(function (val, index) {
                            var opt = $(document.createElement('option'));
                            opt.attr('value', val.codigoMateria);
                            opt.attr('data-json', JSON.stringify(val));
                            opt.text(val.nombreMateria);
                            select_asignatura.append(opt);
                        });
                        select_asignatura.val(aux);
                        
                        select_asignatura.trigger("change");
                   
                        select_asignatura.prop("disabled", false);

                    }
                }
                
            });
        }


    </script>
{% endblock %} 