<?php

namespace VehiculosBundle\Repository;
use AppBundle\Entity\Usuario;
use DateTime;
use VehiculosBundle\Entity\EstadoReserva;
use VehiculosBundle\Entity\HistoricoEstadosReserva;
use VehiculosBundle\Entity\Reserva;
use Symfony\Component\Serializer\Exception\Exception;

/**
 * HistoricoEstadosReservaRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class HistoricoEstadosReservaRepository extends \Doctrine\ORM\EntityRepository
{
    public function setEstadoNueva(Reserva $reserva, Usuario $usuario) {

        $em = $this->getEntityManager();
        $estado = $em->getRepository(EstadoReserva::class)->findOneBy(array(
            'codigo' => EstadoReserva::NUEVA
        ));

        if (!$estado instanceof EstadoReserva) {
            return false;
        }

        $h = new HistoricoEstadosReserva();
        $h->setEstado($estado);

        $fecha = new \DateTime;
        $h->setFechaDesde($fecha);
        $h->setFechaHasta(NULL);//hasta que pase de estado

        $h->setReserva($reserva);
        $h->setUsuario($usuario);

        $em->persist($h);
        $em->flush();

        return true;
    }

        /**
     * Se encarga de especificar un estado a una planificacion existente.
     * 
     * @param Reserva $reserva
     * @param integer $cod_estado
     * @param Usuario $usuario
     * @param string|null $comentario
     * @return boolean
     * @throws Exception
     */
    public function asignarEstado(Reserva $reserva, $cod_estado, Usuario $usuario, $comentario = null) {

        $em = $this->getEntityManager();

        $repoEstados = $em->getRepository(EstadoReserva::class);
        $estado = $repoEstados->findOneBy(array(
            'codigo' => $cod_estado
        ));
        
        if (!$estado instanceof EstadoReserva) {
            return false;
        }

        $res = false;

        $em->beginTransaction();
        try {

            //buscar estado actual:
            $hea = $reserva->getHistoricoEstadoActual();

            //si es distinto de nueva se setea la fecha hasta y se guarda el cambio
            //die($hea->getEstado());
            if ($hea && $hea->getEstado() && $hea->getEstado() !== EstadoReserva::NUEVA) {                
                $hea->setFechaHasta(new DateTime());
                $em->flush();
            }

            //nuevo estado:
            $hn = new HistoricoEstadosReserva();
            $hn->setReserva($reserva);
            $hn->setEstado($estado);
            $hn->setUsuario($usuario);
            $hn->setComentario($comentario);
            
            //modificar fecha de actualizacion:
            //$reserva->setUltimaModif(new \DateTime());

            //guardar nuevo registro
            $em->persist($hn);
            $em->flush();

            $em->commit();

            $res = true;
        } catch (Exception $ex) {
            $em->rollback();
            throw $ex;
        }

        return $res;
    }
}
